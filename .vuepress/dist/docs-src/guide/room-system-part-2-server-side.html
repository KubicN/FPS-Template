<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Room System part 2 (Server-side)</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.9d53ebe0.css" as="style"><link rel="preload" href="/assets/js/app.c9d37527.js" as="script"><link rel="preload" href="/assets/js/14.a916c891.js" as="script"><link rel="prefetch" href="/assets/js/10.32a353f3.js"><link rel="prefetch" href="/assets/js/11.933c19ec.js"><link rel="prefetch" href="/assets/js/12.a02f11f0.js"><link rel="prefetch" href="/assets/js/13.40ac11ba.js"><link rel="prefetch" href="/assets/js/15.b73c1666.js"><link rel="prefetch" href="/assets/js/16.852cf2a8.js"><link rel="prefetch" href="/assets/js/17.dfac54fd.js"><link rel="prefetch" href="/assets/js/2.e2bca5e2.js"><link rel="prefetch" href="/assets/js/3.ca04f91d.js"><link rel="prefetch" href="/assets/js/4.4c29f191.js"><link rel="prefetch" href="/assets/js/5.d9fa2263.js"><link rel="prefetch" href="/assets/js/6.b7b36f4e.js"><link rel="prefetch" href="/assets/js/7.d6545fd4.js"><link rel="prefetch" href="/assets/js/8.819f337e.js"><link rel="prefetch" href="/assets/js/9.226f770f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9d53ebe0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><!---->  <!----> </div> <div class="page"> <div class="content"><h1 id="room-system-part-2-server-side"><a href="#room-system-part-2-server-side" aria-hidden="true" class="header-anchor">#</a> Room System part 2 (Server-side)</h1> <p>In this section will add the functionality to join rooms.
We start by chaning the ClientConnection script a bit:</p> <p>To the other public fields, we add:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token class-name">Room</span> Room<span class="token punctuation">;</span>
</code></pre></div><p>In addition we will let the ClientConnection handle messages:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">OnMessage</span><span class="token punctuation">(</span><span class="token keyword">object</span> sender<span class="token punctuation">,</span> <span class="token class-name">MessageReceivedEventArgs</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">IClient</span> client <span class="token operator">=</span> <span class="token punctuation">(</span>IClient<span class="token punctuation">)</span>sender<span class="token punctuation">;</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">Message</span> m <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">GetMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>Tags<span class="token punctuation">)</span>m<span class="token punctuation">.</span>Tag<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>We have to subscribe the function, in the Constructor add:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>       Client<span class="token punctuation">.</span>MessageReceived <span class="token operator">+</span><span class="token operator">=</span> OnMessage<span class="token punctuation">;</span>
</code></pre></div><p>And create a function to call if the player disconnects:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">OnClientDisconnect</span><span class="token punctuation">(</span><span class="token keyword">object</span> sender<span class="token punctuation">,</span> <span class="token class-name">ClientDisconnectedEventArgs</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        ServerManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>Players<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>Client<span class="token punctuation">.</span>ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ServerManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>PlayersByName<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span>Client<span class="token punctuation">.</span>MessageReceived <span class="token operator">-</span><span class="token operator">=</span> OnMessage<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>Now we add a way to add/reomve a client to our rooms to our Room script and we will also add a Close function to close the room:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">AddPlayerToRoom</span><span class="token punctuation">(</span><span class="token class-name">ClientConnection</span> clientConnection<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        ClientConnections<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>clientConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>
        clientConnection<span class="token punctuation">.</span>Room <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">Message</span> message <span class="token operator">=</span> Message<span class="token punctuation">.</span><span class="token function">CreateEmpty</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span>Tags<span class="token punctuation">.</span>LobbyJoinRoomAccepted<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            clientConnection<span class="token punctuation">.</span>Client<span class="token punctuation">.</span><span class="token function">SendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> SendMode<span class="token punctuation">.</span>Reliable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">RemovePlayerFromRoom</span><span class="token punctuation">(</span><span class="token class-name">ClientConnection</span> clientConnection<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        ClientConnections<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>clientConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>
     	clientConnection<span class="token punctuation">.</span>Room <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token class-name">ClientConnection</span> p <span class="token keyword">in</span> ClientConnections<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">RemovePlayerFromRoom</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">Destroy</span><span class="token punctuation">(</span>gameObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>But we don't know to which room we should add the player so we have to ask the RoomManager first:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">TryJoinRoom</span><span class="token punctuation">(</span><span class="token class-name">IClient</span> client<span class="token punctuation">,</span> <span class="token class-name">JoinRoomRequest</span> data<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">ClientConnection</span> p<span class="token punctuation">;</span>
        <span class="token class-name">Room</span> r<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ServerManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>Players<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token keyword">out</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">Message</span> m <span class="token operator">=</span> Message<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span>Tags<span class="token punctuation">.</span>LobbyJoinRoomDenied<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LobbyInfoData</span><span class="token punctuation">(</span><span class="token function">GetRoomDataList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                client<span class="token punctuation">.</span><span class="token function">SendMessage</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> SendMode<span class="token punctuation">.</span>Reliable<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rooms<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>RoomName<span class="token punctuation">,</span> <span class="token keyword">out</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">Message</span> m <span class="token operator">=</span> Message<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span>Tags<span class="token punctuation">.</span>LobbyJoinRoomDenied<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LobbyInfoData</span><span class="token punctuation">(</span><span class="token function">GetRoomDataList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                client<span class="token punctuation">.</span><span class="token function">SendMessage</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> SendMode<span class="token punctuation">.</span>Reliable<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>ClientConnections<span class="token punctuation">.</span>Count <span class="token operator">&gt;=</span> r<span class="token punctuation">.</span>MaxSlots<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">Message</span> m <span class="token operator">=</span> Message<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span>Tags<span class="token punctuation">.</span>LobbyJoinRoomDenied<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LobbyInfoData</span><span class="token punctuation">(</span><span class="token function">GetRoomDataList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                client<span class="token punctuation">.</span><span class="token function">SendMessage</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> SendMode<span class="token punctuation">.</span>Reliable<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        r<span class="token punctuation">.</span><span class="token function">AddPlayerToRoom</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>We all change the RemoveRoom function because we can Close rooms now to:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">RemoveRoom</span><span class="token punctuation">(</span><span class="token keyword">string</span> name<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">Room</span> r <span class="token operator">=</span> rooms<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rooms<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token punctuation">}</span>
</code></pre></div><p>We do a few checks here to test if the player is logged in, the room exists and if the room has space and if everything is alright we add the player to the room else we send a JoinRoomDenied message back with a refreshed list of RoomDatas.</p> <p>Lets call TryJoinRoom from the ClientConnection script if we get a LobbyJoinRoomRequest:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">OnMessage</span><span class="token punctuation">(</span><span class="token keyword">object</span> sender<span class="token punctuation">,</span> <span class="token class-name">MessageReceivedEventArgs</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">IClient</span> client <span class="token operator">=</span> <span class="token punctuation">(</span>IClient<span class="token punctuation">)</span>sender<span class="token punctuation">;</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">Message</span> m <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">GetMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>Tags<span class="token punctuation">)</span>m<span class="token punctuation">.</span>Tag<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">case</span> Tags<span class="token punctuation">.</span>LobbyJoinRoomRequest<span class="token punctuation">:</span>
                    RoomManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">TryJoinRoom</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> m<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Deserialize</span><span class="token punctuation">&lt;</span><span class="token class-name">JoinRoomRequest</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>and in the OnClientDisconnect function we will remove the player from the room, so add the following lines at the beginning:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Room <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            Room<span class="token punctuation">.</span><span class="token function">RemovePlayerFromRoom</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre></div><p>Your scripts should look like this:</p> <ul><li><a href="https://pastebin.com/VixNs1q9" target="_blank" rel="noopener noreferrer">ClientConnection<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://pastebin.com/MHPGRAbj" target="_blank" rel="noopener noreferrer">Room<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://pastebin.com/j9eXBM5h" target="_blank" rel="noopener noreferrer">RoomManager<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>Now we have a working room system. so we can finally work at the actual gameplay 😃</p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.c9d37527.js" defer></script><script src="/assets/js/14.a916c891.js" defer></script>
  </body>
</html>
