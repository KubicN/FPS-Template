<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Health, Shooting, Lag Compensation</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.9d53ebe0.css" as="style"><link rel="preload" href="/assets/js/app.ef653588.js" as="script"><link rel="preload" href="/assets/js/8.819f337e.js" as="script"><link rel="prefetch" href="/assets/js/10.e140670c.js"><link rel="prefetch" href="/assets/js/11.933c19ec.js"><link rel="prefetch" href="/assets/js/12.a02f11f0.js"><link rel="prefetch" href="/assets/js/13.40ac11ba.js"><link rel="prefetch" href="/assets/js/14.a916c891.js"><link rel="prefetch" href="/assets/js/15.b73c1666.js"><link rel="prefetch" href="/assets/js/16.852cf2a8.js"><link rel="prefetch" href="/assets/js/17.dfac54fd.js"><link rel="prefetch" href="/assets/js/2.e2bca5e2.js"><link rel="prefetch" href="/assets/js/3.ca04f91d.js"><link rel="prefetch" href="/assets/js/4.4c29f191.js"><link rel="prefetch" href="/assets/js/5.d9fa2263.js"><link rel="prefetch" href="/assets/js/6.b7b36f4e.js"><link rel="prefetch" href="/assets/js/7.d6545fd4.js"><link rel="prefetch" href="/assets/js/9.226f770f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9d53ebe0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><!---->  <!----> </div> <div class="page"> <div class="content"><h1 id="health-shooting-lag-compensation"><a href="#health-shooting-lag-compensation" aria-hidden="true" class="header-anchor">#</a> Health, Shooting, Lag Compensation</h1> <p>Before we start to implement health and shooting we will add a simple health bar to our player to display it.
Open the PlayerClient script and add the following variables to the References:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token class-name">Text</span> NameText<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Image</span> HealthBarFill<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">GameObject</span> HealthBarObject<span class="token punctuation">;</span>
</code></pre></div><p>and add the follwing to the Public Fields:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">int</span> Health<span class="token punctuation">;</span>
</code></pre></div><p>Then add these functions:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">SetHealth</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token keyword">value</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Health <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
        HealthBarFill<span class="token punctuation">.</span>fillAmount <span class="token operator">=</span> <span class="token keyword">value</span> <span class="token operator">/</span> <span class="token number">100f</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">LateUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">Vector3</span> point <span class="token operator">=</span> Camera<span class="token punctuation">.</span>main<span class="token punctuation">.</span><span class="token function">WorldToScreenPoint</span><span class="token punctuation">(</span>transform<span class="token punctuation">.</span>position <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>point<span class="token punctuation">.</span>z <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            HealthBarObject<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>position <span class="token operator">=</span> point<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            HealthBarObject<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>position <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>And in the Initialize function after Name = name; add:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code> NameText<span class="token punctuation">.</span>text <span class="token operator">=</span> Name<span class="token punctuation">;</span>
 <span class="token function">SetHealth</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Open the Game scene and drag the player prefab into it.</p> <ul><li>Right click on the player and add a UI canvas.</li> <li>Set the canvas to scale with screen size and set the reference resolution to 1920x1080 and name it &quot;HealthBar&quot;</li> <li>Right click the HealthBar and add an empty gameobject</li> <li>Set the Position Y property of it to 50</li> <li>Right click the gameobject and add an image(as a new gameobject), set source image to UISprite, image type to simple and the height in the transform to 20</li> <li>Right click the image and add another image(as a new gameobject), name it &quot;Fill&quot;. set it's source image to UISprite and it's height to 20 and set the Image Type to filled and Fill Method to Horizontal and Fill Origin to Left.</li> <li>Right click the empty gameobject (child of HealthBar) and add a UI/Text (as a new gameobject).</li> <li>Set the y position of the text to 22 and the font size to 18 and bold.</li> <li>Go to the Player and set NameText to the text object, Health Bar Fill to the Fill object and HealthBarObject to the empty gameobject.</li></ul> <p>Now we have a working health bar that hovers over our player and displays the current health state.</p> <p>Before we start with the actual shooting let's create something to display our shots.</p> <ul><li>Create a new GameObject in the Game scene name it &quot;Shot&quot;</li> <li>Add a line renderer to the object</li> <li>Set the material to default-line</li> <li>And the positions to 2 positions the first being (0,0,0) and the second (0,0,100)</li> <li>Set the color to red and the alpha to something like 120</li> <li>Set the width to 0.2<br> <img src="https://i.imgur.com/YQsYGC9.png" alt></li></ul> <p>Drag it in the prefab folders then delete it from the Scene.</p> <p>Open the ClientPlayer and add:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token punctuation">[</span><span class="token class-name">Header</span><span class="token punctuation">(</span><span class="token string">&quot;Prefabs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token class-name">GameObject</span> ShotPrefab<span class="token punctuation">;</span>
</code></pre></div><p>and in FixedUpdate before:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    yaw <span class="token operator">+</span><span class="token operator">=</span> Input<span class="token punctuation">.</span><span class="token function">GetAxis</span><span class="token punctuation">(</span><span class="token string">&quot;Mouse X&quot;</span><span class="token punctuation">)</span> <span class="token operator">*</span> SensitivityX<span class="token punctuation">;</span>
</code></pre></div><p>add:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>            <span class="token keyword">if</span> <span class="token punctuation">(</span>inputs<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token class-name">GameObject</span> go <span class="token operator">=</span> <span class="token function">Instantiate</span><span class="token punctuation">(</span>ShotPrefab<span class="token punctuation">)</span><span class="token punctuation">;</span>
                go<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>position <span class="token operator">=</span> Interpolation<span class="token punctuation">.</span>CurrentData<span class="token punctuation">.</span>Position<span class="token punctuation">;</span>
                go<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>rotation <span class="token operator">=</span> transform<span class="token punctuation">.</span>rotation<span class="token punctuation">;</span>
                <span class="token function">Destroy</span><span class="token punctuation">(</span>go<span class="token punctuation">,</span><span class="token number">1f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
</code></pre></div><p>Finally we will need a way to change player health over the network so open Networking Data and add:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">struct</span> PLayerHealthUpdateData <span class="token punctuation">:</span> IDarkRiftSerializable
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">ushort</span> PlayerId<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">byte</span> Value<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">PLayerHealthUpdateData</span><span class="token punctuation">(</span><span class="token keyword">ushort</span> id<span class="token punctuation">,</span> <span class="token keyword">byte</span> val<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        PlayerId <span class="token operator">=</span> id<span class="token punctuation">;</span>
        Value <span class="token operator">=</span> val<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Deserialize</span><span class="token punctuation">(</span><span class="token class-name">DeserializeEvent</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        PlayerId <span class="token operator">=</span> e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token function">ReadUInt16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Value <span class="token operator">=</span> e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token function">ReadByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Serialize</span><span class="token punctuation">(</span><span class="token class-name">SerializeEvent</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>PlayerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>And change the GameUpdateData a bit. Add the following below the other arrays:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> PLayerHealthUpdateData<span class="token punctuation">[</span><span class="token punctuation">]</span> HealthData<span class="token punctuation">;</span>
</code></pre></div><p>Also pass an HealthUpdateDataArray into the constructor. It should look like this now:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token function">GameUpdateData</span><span class="token punctuation">(</span><span class="token keyword">uint</span> frame<span class="token punctuation">,</span> PlayerUpdateData<span class="token punctuation">[</span><span class="token punctuation">]</span> updateData<span class="token punctuation">,</span> PlayerSpawnData<span class="token punctuation">[</span><span class="token punctuation">]</span> spawns<span class="token punctuation">,</span> PlayerDespawnData<span class="token punctuation">[</span><span class="token punctuation">]</span> despawns<span class="token punctuation">,</span> PLayerHealthUpdateData<span class="token punctuation">[</span><span class="token punctuation">]</span> healthDatas<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Frame <span class="token operator">=</span> frame<span class="token punctuation">;</span>
        UpdateData <span class="token operator">=</span> updateData<span class="token punctuation">;</span>
        DespawnData <span class="token operator">=</span> despawns<span class="token punctuation">;</span>
        SpawnData <span class="token operator">=</span> spawns<span class="token punctuation">;</span>
        HealthData <span class="token operator">=</span> healthDatas<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>In the serialize function add at the end:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>HealthData<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Same for the deserialize method</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>        HealthData <span class="token operator">=</span> e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ReadSerializables</span><span class="token punctuation">&lt;</span><span class="token class-name">PLayerHealthUpdateData</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Finally open the GameManager and in the PerformGameUpdate function add the following below the last foreach loop:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>   <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">PLayerHealthUpdateData</span> data <span class="token keyword">in</span> updateData<span class="token punctuation">.</span>HealthData<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">ClientPlayer</span> p<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>players<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>PlayerId<span class="token punctuation">,</span> <span class="token keyword">out</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                p<span class="token punctuation">.</span><span class="token function">SetHealth</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre></div><p>Switch to the server project and open the Room script and add:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>PLayerHealthUpdateData<span class="token operator">&gt;</span> HealthUpdates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">List</span><span class="token punctuation">&lt;</span><span class="token class-name">PLayerHealthUpdateData</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>And in the FixedUpdate change the lines that send the message to:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">Message</span> m <span class="token operator">=</span> Message<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span>Tags<span class="token punctuation">.</span>GameUpdate<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">GameUpdateData</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>InputTick<span class="token punctuation">,</span> UpdateDatas<span class="token punctuation">,</span> tpsd<span class="token punctuation">,</span> tpdd<span class="token punctuation">,</span> HealthUpdates<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                p<span class="token punctuation">.</span>Client<span class="token punctuation">.</span><span class="token function">SendMessage</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> SendMode<span class="token punctuation">.</span>Reliable<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
</code></pre></div><p>and at the end of FixedUpdate call:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>        HealthUpdates<span class="token punctuation">.</span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Now open the ServerPlayer and add to the Public Fields:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">int</span> Health<span class="token punctuation">;</span>
</code></pre></div><p>and initialize add after InputTick = Room.ServerTick:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>        Health <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
</code></pre></div><p>also add a function to let a player take damage and respawn him if he dies:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">TakeDamage</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token keyword">value</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Health <span class="token operator">-</span><span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Health <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            Health <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
            CurrentUpdateData<span class="token punctuation">.</span>Position <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span> transform<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>localPosition<span class="token punctuation">;</span>
            CurrentUpdateData<span class="token punctuation">.</span>Gravity <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            transform<span class="token punctuation">.</span>localPosition <span class="token operator">=</span> CurrentUpdateData<span class="token punctuation">.</span>Position<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Room<span class="token punctuation">.</span>HealthUpdates<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PLayerHealthUpdateData</span><span class="token punctuation">(</span>Client<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> Health<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>Now lets do lag compensation 😀</p> <p>To do lag compensation we will need a historyBuffer on the server too so open the ServerPlayer and add:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>PlayerUpdateData<span class="token operator">&gt;</span> UpdateDataHistory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">List</span><span class="token punctuation">&lt;</span><span class="token class-name">PlayerUpdateData</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>and at the end of the PerformUpdate function add:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>        UpdateDataHistory<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>CurrentUpdateData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>UpdateDataHistory<span class="token punctuation">.</span>Count <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            UpdateDataHistory<span class="token punctuation">.</span><span class="token function">RemoveAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre></div><p>We want the shots to be performed in a separate loop before the main game update because then all players are in the same frame. But this means we have to store inputs somehow so in the ServerPlayer add:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">private</span> PlayerInputData<span class="token punctuation">[</span><span class="token punctuation">]</span> inputs<span class="token punctuation">;</span>
</code></pre></div><p>And remove the following line from PerformUpdate:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>        PlayerInputData<span class="token punctuation">[</span><span class="token punctuation">]</span> inputs <span class="token operator">=</span> inputBuffer<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Now add a new function for inputs and shooting:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">PerformuPreUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        inputs <span class="token operator">=</span> inputBuffer<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> inputs<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>inputs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Keyinputs<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                Room<span class="token punctuation">.</span><span class="token function">PerformShootRayCast</span><span class="token punctuation">(</span>inputs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Time<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>We will go implement the missing PerformShootRayCast in the Room:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">PerformShootRayCast</span><span class="token punctuation">(</span><span class="token keyword">uint</span> frame<span class="token punctuation">,</span> <span class="token class-name">ServerPlayer</span> shooter<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">int</span> dif <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>ServerTick <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> frame<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//get the position of the ray</span>
        <span class="token class-name">Vector3</span> firepoint<span class="token punctuation">;</span>
        <span class="token class-name">Vector3</span> direction<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>shooter<span class="token punctuation">.</span>UpdateDataHistory<span class="token punctuation">.</span>Count <span class="token operator">&gt;</span> dif<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            firepoint <span class="token operator">=</span> shooter<span class="token punctuation">.</span>UpdateDataHistory<span class="token punctuation">[</span>dif<span class="token punctuation">]</span><span class="token punctuation">.</span>Position<span class="token punctuation">;</span>
            direction <span class="token operator">=</span> shooter<span class="token punctuation">.</span>UpdateDataHistory<span class="token punctuation">[</span>dif<span class="token punctuation">]</span><span class="token punctuation">.</span>LookDirection <span class="token operator">*</span> Vector3<span class="token punctuation">.</span>forward<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            firepoint <span class="token operator">=</span> shooter<span class="token punctuation">.</span>CurrentUpdateData<span class="token punctuation">.</span>Position<span class="token punctuation">;</span>
            direction <span class="token operator">=</span> shooter<span class="token punctuation">.</span>CurrentUpdateData<span class="token punctuation">.</span>LookDirection <span class="token operator">*</span> Vector3<span class="token punctuation">.</span>forward<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        firepoint <span class="token operator">+</span><span class="token operator">=</span> direction <span class="token operator">*</span> <span class="token number">5f</span><span class="token punctuation">;</span>
        firepoint <span class="token operator">+</span><span class="token operator">=</span> transform<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>localPosition<span class="token punctuation">;</span>

        <span class="token comment">//set all players back in time</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">ServerPlayer</span> player <span class="token keyword">in</span> ServerPlayers<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>player<span class="token punctuation">.</span>UpdateDataHistory<span class="token punctuation">.</span>Count <span class="token operator">&gt;</span> dif<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                player<span class="token punctuation">.</span>Logic<span class="token punctuation">.</span>CharacterController<span class="token punctuation">.</span>enabled <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
                player<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>localPosition <span class="token operator">=</span> player<span class="token punctuation">.</span>UpdateDataHistory<span class="token punctuation">[</span>dif<span class="token punctuation">]</span><span class="token punctuation">.</span>Position<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>



        <span class="token class-name">RaycastHit</span> hit<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>Physics<span class="token punctuation">.</span><span class="token function">Raycast</span><span class="token punctuation">(</span>firepoint<span class="token punctuation">,</span> direction<span class="token punctuation">,</span><span class="token keyword">out</span> hit<span class="token punctuation">,</span> <span class="token number">200f</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>hit<span class="token punctuation">.</span>transform<span class="token punctuation">.</span><span class="token function">CompareTag</span><span class="token punctuation">(</span><span class="token string">&quot;Unit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                hit<span class="token punctuation">.</span>transform<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetComponent</span><span class="token punctuation">&lt;</span><span class="token class-name">ServerPlayer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">TakeDamage</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>


        <span class="token comment">//set all players back</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">ServerPlayer</span> player <span class="token keyword">in</span> ServerPlayers<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            player<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>localPosition <span class="token operator">=</span> player<span class="token punctuation">.</span>CurrentUpdateData<span class="token punctuation">.</span>Position<span class="token punctuation">;</span>
            player<span class="token punctuation">.</span>Logic<span class="token punctuation">.</span>CharacterController<span class="token punctuation">.</span>enabled <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>This looks complicated at the first glance but it isn't. First we calculate for how many frames we have to lag compensate( the -1 because we ticked up already in this tick). Then we set all players back to that point of time by using the history buffers, next we create a ray and check if he hit a &quot;Unit&quot; and if we do we deal damage to that player. Finally we set all players back.</p> <p>The only thing left to do now is to create the &quot;Unit&quot; tag and add it to the player prefab and also to add a capsule collider to the player prefab.</p> <p>Now we can run around on a map with collisions and shoot other players and even join multiple rooms, this should be the basic functions of an FPS. There is still much room to extend to for instance:</p> <ul><li>Let players create rooms</li> <li>Ammo</li> <li>Abilties and cooldowns</li> <li>A death zone if players fall out of the map</li> <li>Well... a better map</li></ul> <p>But I'll leave that to you!</p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.ef653588.js" defer></script><script src="/assets/js/8.819f337e.js" defer></script>
  </body>
</html>
